name: CI

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  backend-tests:
    name: Backend Tests (${{ matrix.backend }})
    runs-on: macos-14
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        backend:
          - pure
          - metal
    env:
      NATTEN_BACKEND: ${{ matrix.backend }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run core tests
        run: >
          python -m pytest -q
          tests/test_na1d.py
          tests/test_na2d.py
          tests/test_na3d.py
          tests/test_functional.py
          tests/test_functional_3d.py
          tests/test_functional_3d_expanded.py
          tests/test_autograd.py
          tests/test_autograd_3d.py
          tests/test_split_ops_grad.py
          tests/test_backends.py

      - name: Run new features tests
        run: >
          python -m pytest -q
          tests/test_new_features.py
          tests/test_nn_module_grad.py

      - name: Run compat & extras tests
        run: >
          python -m pytest -q
          tests/test_compat_v014.py
          tests/test_compat_v015.py
          tests/test_compat_v017.py
          tests/test_compat_v020.py
          tests/test_compat_for_version.py
          tests/test_compat_gradients.py
          tests/test_extras_allin1.py
          tests/test_support_matrix.py
          tests/test_validation_errors.py

  metal-specific:
    name: Metal Backend
    runs-on: macos-14
    timeout-minutes: 20
    env:
      NATTEN_BACKEND: metal
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run Metal-specific tests
        run: >
          python -m pytest -q
          tests/test_metal_backend.py
          tests/test_backward_parity.py
          tests/test_shift_semantics.py
          tests/test_extras_backward.py

  torch-compile:
    name: torch.compile Integration
    runs-on: macos-14
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Verify custom ops registered
        run: |
          python -c "
          import torch, natten_mps
          for name in ['na1d_qk','na1d_av','na2d_qk','na2d_av','na3d_qk','na3d_av',
                       'na1d_fwd','na2d_fwd','na3d_fwd']:
              assert getattr(torch.ops.natten_mps, name, None), f'Missing op: {name}'
          print('All 9 custom ops registered')
          "

      - name: Test torch.compile forward + backward
        run: |
          python -c "
          import torch, natten_mps

          @torch.compile(backend='aot_eager')
          def f(q, k, v):
              return torch.ops.natten_mps.na1d_fwd(q, k, v, [7], [1], [1], [False], None)

          q = torch.randn(1, 16, 4, 32, device='mps', requires_grad=True)
          k = torch.randn(1, 16, 4, 32, device='mps', requires_grad=True)
          v = torch.randn(1, 16, 4, 32, device='mps', requires_grad=True)
          out = f(q, k, v)
          out.sum().backward()
          assert q.grad is not None and q.grad.shape == q.shape
          print('torch.compile forward + backward OK')
          "
